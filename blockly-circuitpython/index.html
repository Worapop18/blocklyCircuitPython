<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blockly + Custom Blocks</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<script src="https://unpkg.com/blockly/python_compressed.js"></script>
<style>
body { margin:0; font-family:sans-serif; background:#eef3ff; }
h1 { margin:0; padding:10px 20px; background:#4a90e2; color:white; }
.main { display:flex; height: calc(100vh - 50px); }
#blocklyDiv { height:100%; width:70%; }
.code-panel { width:30%; background:white; box-shadow:-2px 0 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; padding:5px; }
.code-panel h3 { margin:0; padding:10px; background:#ddd; }
pre { background:#1e1e1e; color:#00ff6a; padding:10px; border-radius:6px; margin:5px 0; overflow:auto; font-family: monospace; }
#code-output { height: 200px; }
#runResult { height: 150px; background:#f0f0f0; color:black; }
.button-group { display:flex; justify-content: space-between; margin:5px 0; }
button { flex:1; margin:0 2px; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
#runBtn { background:#4CAF50; color:white; }
#clearBtn { background:#E53935; color:white; }
#exportBtn { background:#2196F3; color:white; }
</style>
</head>
<body>
<h1>Blockly Python</h1>
<div class="main">
  <div id="blocklyDiv"></div>
  <div class="code-panel">
    <h3>‡πÇ‡∏Ñ‡πâ‡∏î CircuitPython</h3>
    <pre id="code-output"># ‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</pre>
    <div class="button-group">
      <button id="runBtn">‚ñ∂Ô∏è ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á</button>
      <button id="clearBtn">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="exportBtn">üìã Export MicroPython</button>
    </div>
    <pre id="runResult">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</pre>
  </div>
</div>

<!-- Toolbox -->
<xml id="toolbox" style="display: none">
  <category name="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°" colour="#4CAF50">
    <block type="start_code"></block>
  </category>
  <category name="LED" colour="#AB47BC">
    <block type="led_on"></block>
    <block type="led_off"></block>
  </category>
  <category name="‡πÄ‡∏ß‡∏•‡∏≤" colour="#FF7043">
    <block type="sleep_block"><field name="SECONDS">1</field></block>
  </category>
  <category name="‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î" colour="#5C6BC0">
    <block type="button_read"></block>
  </category>
  <category name="Logic" colour="%{BKY_LOGIC_HUE}">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
  </category>
  <category name="Loops" colour="%{BKY_LOOPS_HUE}">
    <block type="controls_repeat_ext">
      <value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
    </block>
    <block type="controls_whileUntil"></block>
  </category>
  <category name="Math" colour="%{BKY_MATH_HUE}">
    <block type="math_number"><field name="NUM">0</field></block>
    <block type="math_arithmetic"></block>
  </category>
  <category name="Text" colour="%{BKY_TEXTS_HUE}">
    <block type="text"></block>
    <block type="text_print"></block>
  </category>
</xml>

<script>
// ---------- Workspace ----------
const workspace = Blockly.inject('blocklyDiv', {
  toolbox: document.getElementById('toolbox'),
  trashcan: true,
  zoom: { controls: true, wheel: true }
});

// ---------- repeat generator ----------
Blockly.Python['controls_repeat_ext'] = function(block) {
  const times = Blockly.Python.valueToCode(block,'TIMES',Blockly.Python.ORDER_NONE) || '0';
  const branch = Blockly.Python.statementToCode(block,'DO') || Blockly.Python.PASS;
  // ‡∏à‡∏±‡∏î indentation ‡πÉ‡∏´‡πâ branch
  const indentedBranch = branch.split('\n').map(line => line ? '  ' + line : '').join('\n');
  return `for i in range(${times}):\n${indentedBranch}\n`;
};

// while
Blockly.Python['controls_whileUntil'] = function(block) {
  const until = block.getFieldValue('MODE') === 'UNTIL';
  let condition = Blockly.Python.valueToCode(block,'BOOL',Blockly.Python.ORDER_NONE) || 'False';
  if (until) condition = 'not (' + condition + ')';
  const branch = Blockly.Python.statementToCode(block,'DO') || Blockly.Python.PASS;
  return `while ${condition}:\n${branch}`;
};

// ---------- Custom Blocks ----------
Blockly.defineBlocksWithJsonArray([
  { type: "start_code", message0: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°", nextStatement: null, colour: 120 },
  { type: "led_on", message0: "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü LED", previousStatement: null, nextStatement: null, colour: 290 },
  { type: "led_off", message0: "‡∏õ‡∏¥‡∏î‡πÑ‡∏ü LED", previousStatement: null, nextStatement: null, colour: 290 },
  { type: "sleep_block", message0: "‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ %1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ",
    args0:[{type:"field_number",name:"SECONDS",value:1,min:0}],
    previousStatement: null, nextStatement: null, colour: 30
  },
  { type: "button_read", message0: "‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (GP14)", output: "Boolean", colour: 230 }
]);

// ---------- Custom block code ----------
const CUSTOM_BLOCK_CODE = {
  'start_code': "print('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°')\n",
  'led_on': "led.value = True\n",
  'led_off': "led.value = False\n",
  'sleep_block': (block) => `time.sleep(${block.getFieldValue('SECONDS')})\n`,
  'button_read': "button.value"
};

// ---------- blockToCustomCode ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö repeat ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ----------
function blockToCustomCode(block) {
  if (!block) return '';

  // custom block
  if (CUSTOM_BLOCK_CODE[block.type]) {
    const val = CUSTOM_BLOCK_CODE[block.type];
    const code = (typeof val === "function") ? val(block) : val;
    if (block.outputConnection) return code.trim();
    return code + blockToCustomCode(block.getNextBlock());
  }

  // repeat blocks
  if (['controls_repeat_ext','controls_repeat','controls_repeat_simple'].includes(block.type)) {
    let py = Blockly.Python.blockToCode(block);
    if (Array.isArray(py)) py = py[0];
    return py + blockToCustomCode(block.getNextBlock());
  }

  // default
  let py = Blockly.Python.blockToCode(block);
  if (Array.isArray(py)) py = py[0];
  return (py || '') + blockToCustomCode(block.getNextBlock());
}

// Fix valueToCode ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö custom block
const oldValueToCode = Blockly.Python.valueToCode;
Blockly.Python.valueToCode = function(block, name, order) {
  const target = block.getInputTargetBlock(name);
  if (target && CUSTOM_BLOCK_CODE[target.type]) {
    const val = CUSTOM_BLOCK_CODE[target.type];
    return (typeof val === 'function' ? val(target) : val);
  }
  return oldValueToCode.call(this, block, name, order);
};

// ---------- live update ----------
const codeOutput = document.getElementById("code-output");
function updateCodeDisplay() {
  const topBlocks = workspace.getTopBlocks(true);
  let allCode = "";
  topBlocks.forEach(block => allCode += blockToCustomCode(block));
  codeOutput.textContent = allCode.trim() || "# ‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°";
}
workspace.addChangeListener(updateCodeDisplay);
updateCodeDisplay();

// ---------- Buttons ----------
document.getElementById("clearBtn").onclick = () => { workspace.clear(); updateCodeDisplay(); };
document.getElementById("exportBtn").onclick = () => {
  navigator.clipboard.writeText(codeOutput.textContent);
  alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
};
document.getElementById("runBtn").onclick = () => {
  const result = document.getElementById("runResult");
  const code = codeOutput.textContent;
  result.textContent = code.trim()=='' ? '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô' : 'üöÄ (‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á)\n\n' + code;
};
</script>
</body>
</html>
